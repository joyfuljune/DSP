
# <div align='center'>音频变调 </div>
  
 ## 简介
 在上一次实验中，我们介绍了如何将音频进行变速播放的算法Phase Vocoder，本次实验是在其基础上，介绍将音频变调的实现方法，此外我们会简要介绍关于共振峰的概念，让音频变调但不变音色。
 
 ## 一个简单的案例

| ![image](https://user-images.githubusercontent.com/88413945/183797948-c495ad46-80ca-4aa4-9a55-0e26293fdcf6.png)| 
| :-: |
| **图1. 钢琴C3和E3的频谱图** |

图上是钢琴中音C（do）和中音E（mi）信号的频谱图。我们通常说E的音调比C高，或者我们说女声的频率比男声高，指的都是基本频率（基频）。体现在图上就是频谱上的第一个标注点，do中为261.339Hz，mi中为329.607Hz。因为329大于261，所以我们听到的音调就是E比C要高。同理，我们可以观察下图男声和女声的一帧信号的频谱图

| ![image](https://user-images.githubusercontent.com/88413945/183798295-f0d753ad-55e9-4793-a28f-338fee7f6704.png) |
|:-:|
| **图2. 女性和男性声音频谱图对比** |

男性的基频在113Hz左右，女性在197Hz左右。我们通常区分男女声就可以通过基频是否大于160Hz来判断。除了基频之外我们还能在图中观察到几个波峰，这些被称作是谐波，是基频的整数倍，对于人声信号谐波最高可达5000Hz，但是这些声音几乎不可能被听见。人声变调的原理就在于将信号频谱高低搬迁。
在MATLAB中，可以通过调用<code> f0 = pitch(x,fs) </code> 函数直接得到语音信号基频。（要求MATLAB版本在2018以后）

## 人体发声原理
| ![image](https://user-images.githubusercontent.com/88413945/183798585-0e04c52c-a616-47ce-88bd-ba80a6af71b3.png)|**图3. 人体发声器官示意图**|
|-|-|

当我们说话时，空气通过肺部传递到声带，声门的闭合引发空气震动，再传过调音区就形成了语音信号。简单来说，有两个部分，声带（声源区）和过滤器（调音区）。源负责发出信号，过滤器修饰信号。所以假设大家唱同一首歌的第一个音，音调一样，也就是频率一样，源头是一致的，但是通过过滤器后，我们的口腔的形状、舌头的位置等都会对音色进行修改，所以区别了每个人不同的说话声音。即使我们改变了语音信号的基频，将女性声音的音调变得低沉后，其结果也并不太像是男性声音，其原因就是我们没有对过滤器部分进行修改。

## 共振峰
过滤器，也就是图中的调音区部分不同区分了每个人不同的音色。描述这一部分的参数被称作是共振峰（formant）。共振峰和基频之间并无直接关系，一个是过滤部分，一个是声源部分，但是由于口腔内空气的传播造成的共振会和声源部分相互影响，所以共振峰往往出现在谐波附近，看似成了基频的整数倍处，这也造成了区分共振峰和谐波的困难。
以下显示了分别发出元音【ah】，【ee】，【oo】的频谱图，可以明显看出三个不同元音的共振峰的不同。

|<img src="https://user-images.githubusercontent.com/88413945/183798734-edac783f-929b-4a9c-975f-71a3e651546d.png" width = "500" height = "400">| 图4. 不同元音的共振峰对比|
|-|-|


人类的发声器官限定了我们的共振峰是有固定范围的，比如对于元音i或者u来说，女性的共振峰范围在600\~2900Hz，男性在500\~2600Hz。当我们升高了音调，我们也会升高共振峰，如果超过了正常人类的共振峰范围，那么音频听起来就会有像是 “小黄人”或者“花栗鼠”这样的音色。怎样才能在升高音调（升高基频）的同时保留共振峰？
我们需要共振峰修正。由于涉及知识点较为复杂，本次实验以保留频谱幅度为思想实现保留共振峰的目的。如下图所示，我们将原始语音信号的频率提高一倍，从图a得到图b，可以看出频谱的包络（橘色线条）被拉伸了，通过频谱幅度修正，我们可以回到原始频谱的保留，得到图c。

|<img src="https://user-images.githubusercontent.com/88413945/183798874-7e849ded-71c9-4dbb-8f8f-e62750e7cacd.png" width="500" height="500">|图5. 共振峰修正概念图<br>a. 原始频谱及其包络<br>b. 音调升高频谱及其包络<br>c. 修正后升高频谱及其包络|
|-|-|

## PV 变调
在上一次实验中，我们基于PV原理对音频实现了变速处理，回忆其流程
<ul>
  <li>分析：首先将音频分帧加窗，得到每帧信号的频谱；</li>
  <li>处理：根据变速因子重建每帧信号的频谱的幅度和相位，PV的核心思想就是通过修正相位消除重建信号每帧之间的不连续性；</li>
  <li>合成：将帧信号经过重叠相加还原为时域信号。</li>
</ul>

变调的原理和变速基本相似，在变速中，如果我们想要压缩音频为原长1/2，对于幅度谱而言，只需要每2帧信号保留一帧，就可以实现这一目的。在变调中，我们可以延续这个思路，如果想要降低基频为原来2倍，我们仍旧每2帧信号保留一帧，使得合成后的语音信号为原来信号的1/2长，频率为原始频率，此时我们再对合成语音进行插值，使其长度和原始音频长度一致，已知时间和频率成反比，那么由于时长变长，频率自然降低为原始频率的1/2。

各位需要完成的任务是：
<ol>
  <li> 在ex2中回答所有问号<font color="red">？</font>对应的正确答案 </li>
  <li> 理解ex4中第40行代码的意义 </li>
</ol>
<code> y_interpolated = interp1(real(y_out), linspace(1,length(y_out), length(x)),'linear');</code>

整个流程如下图所示。  
|![image](https://user-images.githubusercontent.com/88413945/183805981-b43c78ed-f8ed-4c71-a578-41b1ca17dd16.png)| 图6. 音频变调流程图|
| - | - |

## 频谱幅度修正原理
如前文所说，修正频谱幅度可以简单实现修正共振峰的目的，达到维持原声音质的效果。
假设我们有原始音频orig2.wav，可以看到他的共振峰谱图如下，Fundamental标记了基频所在位置，F标记了前2个共振峰的位置。
|![image](https://user-images.githubusercontent.com/88413945/183807010-db578c2e-1669-4536-9c99-296f708600ab.png)|图7. A 原始音频 [orig2.wav](https://github.com/joyfuljune/DSP/blob/main/projects/P3/audio/orig2.wav)|
| - | - |

假若我们升高了音调，基频和共振峰的位置同时向右偏移，可以看到共振峰的波形相比原始要宽，修正共振峰使得波形和原始一致。

|![image](https://user-images.githubusercontent.com/88413945/183807035-bde0ca7c-455e-49ef-ae3f-c039dbf986ee.png)|图7. B 变调音频 [orig2_shift.wav](https://github.com/joyfuljune/DSP/blob/main/projects/P3/audio/orig2_shift.wav)|
| - | - |

最终的目的是达到下图，基频向右升高，共振峰包络不变。

|![image](https://user-images.githubusercontent.com/88413945/183807052-a7b04b31-8d42-4e37-ab21-6ee26c992fe9.png)|图7. C 修正音频 [orig2_corr.wav](https://github.com/joyfuljune/DSP/blob/main/projects/P3/audio/orig2_corr.wav)|
| - | - |

在算法中，我们的思路是，
<ol>
  <li> 分析阶段，对原始音频信号分帧加窗后得到每帧信号的频谱，如图A所示</li>
  <li> 求得每帧信号的包络，如图A中F折线所示 </li>
  <li> 用每帧信号的频谱除以包络得到消除共振峰后的语音频谱残留 </li>
  <li> 根据变调因子和第2步中的包络重构F折线，如图C中F折线所示 </li>
  <li> 将第3步中的语音频谱残留乘以第5步中的重构包络得到图C语音信号。 </li>  
  
  这一部分需要大家完成ex5中的所有问号<font color="red"> ? </font>并修改ex4中的***sig***为1。





